Keyboard controls
=================


Add some keyboard controls for the Turtle ui.

```
2025-11-20		Start ðŸ–®ðŸŽ›
```


Same caveats as I had for year-clock, but am interested in adding a few keyboard controls here.
(Same issues also with inputs and focus.)

For example:
	d		- do
	c		- clear
	o		- origin
	m		- marker
	+/-		- zoom
	del		- undo last


Note that 'c' has three initial candidates - clear, center turtle, cartesian - so need to figure those out.


There was also an idea I had ages ago to preprogram some moves into the arrow keys and use them to move the turtle around.
Given how complex turtle/point arithmetic is starting to look, might want to hold off a tad on this one.
But not necessarily a bad idea.


Starting ideas
--------------

There are some keys I should probably be pretty hesitant about mapping outright such as del, home and backspace.
Pretty sure backspace as 'navigate back' is deprecated these days, but some browsers might still use it.

The couple of keyboard controls I added into year-clock were done very quickly, and I have had some ideas about how I mgiht do it better now:
* Filter out keypress events on known input types such as textareas, date inputs etc
* Have a keyboard mode toggle switch in the UI
* Only register keyboard listeners on the SVG element itself, not the whole document

The last will probably be the simplest.
Some sort of way of indicating what has focus might be nice though.


### Keyboard API

I should review this, it's marked as experimental but looks to have fairly solid browser support?:

https://developer.mozilla.org/en-US/docs/Web/API/Keyboard_API

Not sure if its new or just some parts are updated.


### Registering keyboard events

On that topic, I've been thinking about how to do it, and in the 'old' way of doing things i'd need two layers of registration i think.
A primary for the generic keydown, then a secondary to farm out the individual keys to their respective handlers.



Breaking up the App
-------------------

This has been on my mind for a little while.
The app classes are getting a bit bloated in single files/classes so I'm wondering about ways to break them apart into related concerns.
The first thoughts I had were breaking out things by type such as listeners or handlers.
That would probably be okay short term, but grouping by topic might work out a bit better.

So for instance
* application & storage - startup/shutdown, saving state
* html user interface / forms
* svg page - backgrounds/grid; the turtle
* drawing elements

That sort of looks okay, but I'm wondering where the keyboard controls should go in that scheme.
The ones I have in mind for now are mostly turtle commands, but also some page/UI controls.
Some commands might also depend on what has focus, which will affect the decision of where to register the event.

If it were to be broken up into widgets or components then each might to do their own registration.



Aside: checkJs & JSDoc
----------------------

This is something I've been curious about for a little while, but only very recently tried.
I remember reading a while back that Svelte were removing or making optional some of their TypeScript tooling, and using JSDoc instead in some places - I don't remember the details.

So it seems that there are ways of opting in to some TS-style typechecking without a complete changeover.
The details of all this I'm still figuring out, and some might be VSCode setup specific.

For now I've added a minimal `jsconfig.json` file and started fixing the code:
```json
{
	"compilerOptions": {
		"checkJs": true,
		"target": "es2024", // es6, es2024
	}
}
```

With that in place it's a bit more pernickity about things like page elements having the correct interfaces - eg using regular `getElementById` sometimes doesn't return the right *type*.
Had to fix some HTML form elements and SVGGraphicsElement references; also it wants me junk old/bad code which is good.
I tried adding some type annotations, but will come back to that.

The updates for Turtle were *fairly* easy, once I'd figured out what it wants and how to fix it, so I'll keep it around here for a while and see how things go.
I can always turn it off for a stint if needed.



Back to breakup
---------------

One of the things I had some concerns about was how 'this' was going to be handled.
The page app for turtle started out fairly small so using 'this' was okay, but it's growing so more namespaces will be needed.

In particular how I've used `item.listener.bind(this)` in the HTML app might have to change.
That was mainly for the benefit of the class setup.

It's not clear enough to me yet what might need changing, so just going to have a crack and see I think, will start with something small.


### Focus
I think I want to do a bit of refresher on how focus works - i'm thinking it would be nice to indicate whether the forms or the page has focus so that it's clear where keyboard events are going.

`:focus-within` on the forms actually works fairly well, though it has a couple of quirks.
Checkboxes seem to unfocus and focus during the click event so the focus effect blinks - not sure why that's happening.
Also not sure if there's a way to give focus to elements other than form or tabbable elements.
I'd like to be able to click into the forms to give them focus, and also back onto the page.

Turns out adding `tabindex="0"` to the forms and the svg element does what I want - apparently you should avoid anything other than 0 for accessibility reasons.
Not sure if it's a bad idea to do what I'm doing here in that case...


### Shadow dom and css

Mostly happy with the focus feature on the forms, but am trying to break apart the transition animation rules so I can apply them in more targeted ways.
For instance I wanted to get rid of the transition on the form-focus as it was superfluous, and there was another competing focus colour change coming from the browser.
I've also wanted to experiment with a slider for the page animation speed.
Got the slider working (though not sure yet if I like it) but there's a quirk turning up in the way the that the transition property applies (or doesn't) to the shadow dom.

The difference is between these two:
```css
* {
	transition: all 0.5s ease-in;			/* previously I just had this as a one-size-fits-all */
}

.svg-element * {
	transition: all 0.5s ease-in;			/* tried to target only svg and descendants with this */
}
```
With the second the transition property is not applying to items in the shadow dom, specifically the turtle and markers that are `use` elements.
Also the behaviour here seems to vary between ff and chrome (I've tweaked it before in the past) and I think I read that there were upcoming changes to chrome that might affect this behaviour.
I'll try to find a reference.
So right now I'm not 100% sure what the 'correct' behaviour is, and which browser gets it right.
Need to do more digging.

From: https://developer.mozilla.org/en-US/docs/Web/SVG/Reference/Element/use
> Since the cloned nodes are not exposed, care must be taken when using CSS to style a <use> element and its cloned descendants. CSS properties are not guaranteed to be inherited by the cloned DOM unless you explicitly request them using CSS inheritance.

Hmmm. Okay....?
Little more info would be nice.
I feel like there's potentially some cross-learning here with web components and their use of shadow dom.


Experimenting
-------------
I've been off experimenting with other things, time to bring this back.

For now `use` and css are still unsolved and a bit browser dependent, so will shelve for the minute.
I have the behaviour I want in FF, will try to apply to Chrome as I get closer to figuring things out.
I'm also starting to look into web-components, hopefully they'll provide better ways to target shadow dom, will see.

Have also experimented with giving focus to the turtle, however results are mixed.
It works, and the browser draws a nice focus rect (that rotates), but the focus and move transitions become a bit quirky and browser-varying.
Will need more work.


Basic keyboard events
---------------------

I've tentatively added a 'keyboard' module where I can put code related to it.
Wasn't sure if splitting it out would work, but it seems okay.
Have a few basic commands going too.

Zoom in/out will require a little rejigging.
But I'm starting to think - if breaking this up worked okay and is that easy, I should do some others....

### Breakup again

Hmm. Not obvious to me yet along what lines I should split things.
Might sit back on this for a bit.
There'll be an MVCish or subject pattern that will occur shortly.
Most events require a few different changes in a few different spots, ie the html UI and the svg display.
Need to figure out good way to delegate things.

Well I've done *something* as a first pass: have broken out code for the html-ui and the svg document.
I'll revisit it as necessary.


Class experiment
----------------

Now trying to add in some more keyboard controls; if I get any of this right I should be able to intercept events and divvy out updates to the html UI and svg display.
It's still a bit awkward though - I need a dedicated controller of some sort to act as a primary listener, and right now that is the turtleApp itself.
It will probably need some more reorganising.

It occurred to me that a class might actually provide some nice syntactical ergonomics for some of what I'm doing here, so I'm going to try a little experiment.
I'm converting the UI module to be mainly a class instance so I can use getter and setter syntax.
Might work out, might not, just a quick try.

Seems okay so far, not a complete disaster - one thing to be wary of is the 'this' binding in event listeners.
Like this you can't place listeners in the secondary classes - they have to be in the main app class or as raw module functions.
I might move all the listeners, specifically those that require the event object, together into a dedicated module for that reason.
I think i want to tighten up the terminology re listener vs handler as well.

I've done some more reshuffling, going for an MVC-ish structure now.
The html and svg become views, and all the listener/handler code is going into a central 'controller' module.
Still kinda messy, but getting better.

Have also added keyboard controls for turtle visibility, centering and page rotation.


Wrapup
------

Going to start wrapping this up, there's more I want to do but there's enough here to justify a release now.

* Added a general document keyboard listener; event propagation is stopped on the command textarea (N.B. actually responding to kbd event *characters*)
* Added jsconfig with checkJs - fixed initial typing issues, and have started adding JSDoc type annotations
* Updated page item focus - the forms are now focusable, which is visible, and made the focus effect more consistent across elements and browsers
* Also experimented with making the turtle focusable, but had quirks so holding back for now
* Tried out some styles for ninja turtles -> [multi turtle](<ê™®ðŸ¢ - multi-turtle.md>)
* App breakup - the monolithic turtleApp has been broken apart. Went through a few different iterations, but for now have an MVC-lite arrangement.
* The HTML ui and SVG display have become views - implemented in their own modules, as classes for some of the syntactic niceties
* Now have a separate controller module - this still needs work but it's a step in the right direction
* Have added keyboard controls for: do, clear, origin, cmd tabs, zoom, turtle show & center, page rotation


### Future work
* Add cyclic keyboard toggles for grid display and mouse mode
* Move the listener registration to the controller
* Clean up the main turtleApp so that the application lifecycle is a bit clearer
* Add a help/info popover: turtle commands, keyboard controls etc
